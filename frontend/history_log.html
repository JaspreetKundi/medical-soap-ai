<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical History - MedAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="theme.css">
    <script src="theme.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 260px; min-height: 100vh; position: fixed; }
        .main-content { margin-left: 260px; padding: 30px; }
        .nav-link { font-weight: 500; padding: 12px 20px; border-radius: 8px; margin-bottom: 5px; }
        .badge-complete { background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
    </style>
</head>
<body>

    <div class="sidebar p-3 d-flex flex-column">
        <h4 class="mb-4 text-primary fw-bold px-2">ğŸ¥ MedAI Scribe</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">ğŸ  Dashboard</a></li>
            <li class="nav-item"><a href="directory.html" class="nav-link">ğŸ‘¥ My Patients</a></li>
            <li class="nav-item"><a href="history_log.html" class="nav-link active">ğŸ“‚ Full History</a></li>
            <li class="nav-item"><a href="settings.html" class="nav-link">âš™ï¸ Settings</a></li>
        </ul>
        <div class="mt-auto">
            <a href="index.html" class="nav-link text-danger">ğŸšª Sign Out</a>
        </div>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div><h2 class="fw-bold">ğŸ“‚ Patient Records</h2><p class="text-muted">Archive of all completed visits.</p></div>
            <input type="text" id="historySearch" class="form-control w-25" placeholder="ğŸ” Search records...">
        </div>
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead>
                        <tr><th class="ps-4">ID</th><th>Patient Name</th><th>DOB</th><th>Summary</th><th>Status</th><th>Action</th></tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";
        document.addEventListener("DOMContentLoaded", () => {
            fetchHistory();
            document.getElementById("historySearch").addEventListener("input", (e) => fetchHistory(e.target.value.toLowerCase()));
        });
        async function fetchHistory(query = "") {
            const tbody = document.getElementById("historyTableBody");
            try {
                const res = await fetch(`${API_URL}/patients`);
                const allPatients = await res.json();
                const historyPatients = allPatients.filter(p => {
                    const matchesSearch = p.last_name.toLowerCase().includes(query) || p.first_name.toLowerCase().includes(query);
                    return p.status === "Complete" && matchesSearch;
                });
                tbody.innerHTML = "";
                historyPatients.forEach(p => {
                    tbody.innerHTML += `<tr><td class="ps-4 text-muted">#${p.id}</td><td class="fw-bold">${p.last_name}, ${p.first_name}</td><td>${p.dob}</td><td>${p.history_summary}</td><td><span class="badge-complete">âœ… Complete</span></td><td><a href="patient_profile.html?id=${p.id}" class="btn btn-sm btn-outline-primary">ğŸ“„ View Record</a></td></tr>`;
                });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>